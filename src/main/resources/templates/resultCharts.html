<div id="charts">
    <div id="chart_level"></div>
    <div id="chart_area"></div>
    <div id="chart_storage"></div>
</div>
<div class="tabbable tabs-left">
    <ul class="nav nav-tabs">
        <li class="active" id="charts_nav_l1" onclick="f1()"><a>水<br>位<br>高<br>度</a></li>
        <li id="charts_nav_l2" onclick="f2()"><a>水<br>域<br>面<br>积</a></li>
        <li id="charts_nav_l3" onclick="f3()"><a>蓄<br>水<br>量</a></li>
    </ul>
</div>
<script src="../static/js/echarts_stat.min.js"></script>
<script>
    let l1 = $("#charts_nav_l1");
    let l2 = $("#charts_nav_l2");
    let l3 = $("#charts_nav_l3");
    let c1 = $("#chart_level");
    let c2 = $("#chart_area");
    let c3 = $("#chart_storage");
    let active = 1;
    function f1(){
        removeActive();
        l1.addClass("active");
        c1[0].scrollIntoView();
        active = 1;
    }
    function f2(){
        removeActive();
        l2.addClass("active");
        c2[0].scrollIntoView();
        active = 2;
    }
    function f3(){
        removeActive();
        l3.addClass("active");
        c3[0].scrollIntoView();
        active = 3;
    }

    function removeActive() {
        l1.removeClass("active");
        l2.removeClass("active");
        l3.removeClass("active");
    }

    function scroll(){
        let distance = $("#charts").scrollTop();
        if (distance <= c1.height() * 0.5 && active !== 1){
            removeActive();
            l1.addClass("active");
            active = 1;
        }
        else if (distance > c1.height() * 0.5 && distance <= c1.height() + c2.height() * 0.5 && active !== 2){
            removeActive();
            l2.addClass("active");
            active = 2;
        }
        else if (distance > c1.height() + c2.height() * 0.5 && distance <= c1.height() + c2.height() + c3.height() * 0.5 && active !== 3){
            removeActive();
            l3.addClass("active");
            active = 3;
        }
    }

    $("#charts").on('scroll', function () {
        scroll();
    });

    //echart初始化
    let chartLevel = echarts.init(c1[0]);
    let chartArea = echarts.init(c2[0]);
    let chartStorage = echarts.init(c3[0]);

    chartLevel.setOption({
        title: {
            text: '水位高度'
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            }
        },
        legend: {
            data:['实测水位', '遥测水位']
        },
        xAxis: {
            data: []
        },
        yAxis: {},
        series: []
    });
    chartArea.setOption({
        title: {
            text: '水域面积'
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            }
        },
        legend: {
            data:['SAR影像数据', 'SAR影像数据拟合曲线','光学影像数据','光学影像数据拟合曲线']
        },
        xAxis: {
            type:"time"
        },
        yAxis: {
            type: 'value',
        },
        series: []
    });
    chartStorage.setOption({
        title: {
            text: '蓄水量'
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            }
        },
        legend: {
            data:['根据遥测水位和SAR水域面积', '根据遥测水位和光学水域面积','根据遥测水位、SAR水域面积和光学水域面积','根据实测水位、SAR水域面积和光学水域面积']
        },
        xAxis: {
            data: []
        },
        yAxis: {},
        series: []
    });


function reload_chart(){
    //获取数据

    let startDate = $("#startDate").val();
    let endDate = $("#endDate").val();
    if (startDate > endDate){
        alert("输入日期有误");
        $("#endDate").focus();
        return;
    }
    let formData = new FormData();
    formData.append("startDate", startDate.replace(/-/g, '/'));
    formData.append("endDate", endDate.replace(/-/g, '/'));
    chartLevel.showLoading();
    chartStorage.showLoading();
    chartLevel.clear();
    chartStorage.clear();
    $.ajax({
        type: "POST",
        url: "getWaterLevel",
        processData: false,
        contentType: false,
        data: formData,
        success:function (data) {
            if (data!=="error") {
                let json = JSON.parse(data);
                chartLevel.setOption({
                    title: {
                        text: '水位高度'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        }
                    },
                    xAxis: {
                        data: json.x
                    },
                    yAxis: {},
                    series: [{
                        name: '实测水位',
                        type: 'line',
                        data: json.y1
                    },{
                        name: '遥测水位',
                        type: 'line',
                        data: json.y2
                    }]
                });
                chartLevel.hideLoading();
            }
        }
    });
    $.ajax({
        type: "POST",
        url: "getWaterStorage",
        processData: false,
        contentType: false,
        data: formData,
        success:function (data) {
            if (data!=="error") {
                let json = JSON.parse(data);
                chartStorage.setOption({
                    title: {
                        text: '蓄水量'
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross'
                        }
                    },
                    xAxis: {
                        data: json.x
                    },
                    yAxis: {},
                    series: [{
                        name: '根据遥测水位和SAR水域面积',
                        type: 'line',
                        data: json.y1
                    },{
                        name: '根据遥测水位和光学水域面积',
                        type: 'line',
                        data: json.y2
                    },{
                        name: '根据遥测水位、SAR水域面积和光学水域面积',
                        type: 'line',
                        data: json.y3
                    },{
                        name: '根据实测水位、SAR水域面积和光学水域面积',
                        type: 'line',
                        data: json.y4
                    }]
                });
                chartStorage.hideLoading();
            }
        }
    });
}
    $(document).ready(function () {
        chartArea.showLoading();
        reload_chart();
        $.get("getWaterArea", function (data) {
            let json = JSON.parse(data);
            let d1 = [];
            for (let i = 0; i<json[0].length;i++){
                d1.push([new Date(json[0][i].date), json[0][i].area]);
            }
            let d2 = [];
            for (let i = 0; i<json[1].length;i++){
                d2.push([new Date(json[1][i].date), json[1][i].area]);
            }
            let sarRegression = ecStat.regression('polynomial', d1, 4);
            let opticalRegression = ecStat.regression('polynomial', d2, 4);
            chartArea.setOption({
                series: [{
                    name: 'SAR影像数据',
                    symbolSize: 10,
                    type: 'scatter',
                    data: d1
                },{
                    name: '光学影像数据',
                    symbolSize: 10,
                    type: 'scatter',
                    data: d2
                },{
                    name: 'SAR影像数据拟合曲线',
                    type: 'line',
                    smooth: true,
                    showSymbol: false,
                    data: sarRegression.points,
                    markPoint: {
                        itemStyle: {
                            color: 'transparent'
                        },
                        data: [{
                            coord: sarRegression.points[sarRegression.points.length - 1]
                        }]
                    }
                }, {
                    name: '光学影像数据拟合曲线',
                    type: 'line',
                    smooth: true,
                    showSymbol: false,
                    data: opticalRegression.points,
                    markPoint: {
                        itemStyle: {
                            color: 'transparent'
                        },
                        data: [{
                            coord: opticalRegression.points[opticalRegression.points.length - 1]
                        }]
                    }
                }]
            });
            chartArea.hideLoading();
        });
    });

$("#select_date_button").on('click', function () {
    reload_chart();
})





</script>